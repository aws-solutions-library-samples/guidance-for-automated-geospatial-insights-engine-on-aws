# Notifications Module

## Overview

The `Notifications` module manages user subscriptions to notifications generated by ARCADE modules. For now, it only supports `sms` subscription using the mobile number entered in Cognito during registration.

## Architecture

### ARCADE Conceptual Architecture

![conceptual](docs/images/ARCADE%20HLA-notifications-conceptual.png)

The `Notifications` is intended to be orchestrated by a _UI_, or some other application or system, e.g. a _UI_ could provide the ability for users to subscribe notifications related to specific `Region`.

When user subscribes to notifications for a region, the `Notifications` module publishes events. In the ARCADE system, the `Notifications` module is subscribed to `Job change` events. These events are published by the `Executer` module whenever it processes images for a specific region. By subscribing to these events, the notifications module can receive real-time updates on the status and progress of image processing jobs.

### Notifications Logical Architecture

![logical](docs/images/ARCADE%20HLA-notifications.png)

The `Notifications` module provides a REST API (see [swagger](./docs/swagger.json)) to enable the creation and deletion of subscription of `Region` events. The REST API is implemented as a fat lambda that is proxied via API Gateway.

API Gateway utilizes Cognito for authentication, and Verified Permissions for authorization. Currently, authorization is performed at the REST API endpoint level (e.g. only `admin`'s allowed to `POST`), but the use of Verified Permissions allows this to be extended to FGAC (fine-grained access control) if needed in the future.

DynamoDB is used as the datastore. A single table design is taken, with composite keys, GSI overloading, and GSI sharding. Refer to [DynamoDB design doc](./docs/DynamoDB%20design.md) for further details.

SNS is the messaging service used to broadcast notifications. A dedicated SNS topic is created for each region within the ARCADE platform. Whenever a notification needs to be sent, a message is published to the topic. This message is then automatically forwarded to all users who have subscribed to that particular topic.

## Applications Events

```json
{
  "version": "0",
  "id": "b06dbe5c-19bc-4244-ac3d-84ced74e53e6",
  "detail-type": "com.aws.arcade.notifications>Subscription>created",
  "source": "com.aws.arcade.notifications",
  "account": "111122223333",
  "time": "2014-04-22T18:43:48Z",
  "detail": {
  "eventType": "created",
  "id": "ab6gtsfabc61",
  "resourceType": "Subscription",
  "old": {
    // resource attributes before the update
  },
  "new": {
    // resource attributes after the update
  }
}
```

Of interest here:

- `detail-type` is comprised of `com.aws.arcade.notifications>:resourceType>:eventType`.
- `source` is the identifier of the module -  `com.aws.arcade.notifications`.
- `eventType` is one of `created`, `updated`, or `deleted`.
- `resourceType` is `Subscription`.
- `old` is provided when `eventType` is `updated` or `deleted`.
- `new` is provided when `eventType` is `created` or `updated`.
